{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://guest-composer/external root \"flarum.core.compat['tags/components/TagSelectionModal']\"","webpack://guest-composer/webpack/bootstrap","webpack://guest-composer/webpack/runtime/compat get default export","webpack://guest-composer/webpack/runtime/define property getters","webpack://guest-composer/webpack/runtime/hasOwnProperty shorthand","webpack://guest-composer/external root \"flarum.core.compat['forum/app']\"","webpack://guest-composer/external root \"flarum.core.compat['common/extend']\"","webpack://guest-composer/external root \"flarum.core.compat['forum/components/IndexPage']\"","webpack://guest-composer/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://guest-composer/external root \"flarum.core.compat['common/components/Button']\"","webpack://guest-composer/external root \"flarum.core.compat['forum/components/DiscussionComposer']\"","webpack://guest-composer/external root \"flarum.core.compat['forum/components/ReplyComposer']\"","webpack://guest-composer/./src/forum/index.js"],"sourcesContent":["if(typeof flarum.core.compat['tags/components/TagSelectionModal'] === 'undefined') { var e = new Error(\"Cannot find module 'flarum.core.compat['tags/components/TagSelectionModal']'\"); e.code = 'MODULE_NOT_FOUND'; throw e; }\n\nmodule.exports = flarum.core.compat['tags/components/TagSelectionModal'];","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/IndexPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ReplyComposer'];","// /flarum/app # composer config repositories.guest-composer path /extensions/guest-composer\n// /flarum/app # composer require yours/guest-composer:*\n// /flarum/app # composer config minimum-stability dev\n// /flarum/app # composer config prefer-stable true\n// /flarum/app # composer require yours/guest-composer:*\n\n\n\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport IndexPage from 'flarum/forum/components/IndexPage';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport Button from 'flarum/common/components/Button';\nimport DiscussionComposer from 'flarum/forum/components/DiscussionComposer';\nimport ReplyComposer from 'flarum/forum/components/ReplyComposer';\n\n// (опционально) аккуратно попытаемся подключить выбор тегов, если flarum/tags установлен\nlet TagSelectionModal = null;\ntry {\n  // @ts-ignore\n  TagSelectionModal = require('flarum/tags/components/TagSelectionModal').default;\n} catch (e) {\n  TagSelectionModal = null;\n}\n\nfunction openReplyComposer(discussion) {\n  app.composer.load(ReplyComposer, { discussion });\n  app.composer.show();\n}\n\nfunction openNewDiscussionComposer({ withTags = true } = {}) {\n  app.composer.load(DiscussionComposer, {}); // <-- именно так: класс + attrs\n  app.composer.show();\n\n  if (withTags && TagSelectionModal) {\n    app.modal.show(TagSelectionModal, {\n      selectedTags: [],\n      onsubmit: tags => {\n        // Flarum сам подхватит tags из модалки при публикации\n        // (если нужно, можно сохранить в app.composer.fields, но обычно не требуется)\n      },\n    });\n  }\n}\n\n//Show composer for guests\napp.initializers.add('anon-guest-composer', () => {\n\n\n  const AUTO_TAG_ID = '2'; // ← change this to your tag id\n\n  const origSubmit = DiscussionComposer.prototype.onsubmit;\n  DiscussionComposer.prototype.onsubmit = function (e) {\n\n    const data = this.data();\n    data.relationships = data.relationships || {};\n    data.relationships.tags = { data: [{ type: 'tags', id: AUTO_TAG_ID }] };\n\n    this.data = () => data;\n\n    return origSubmit.call(this, e);\n  };\n\n  //\n  const isGuest = !app.session?.user;\n  if (!isGuest) return;\n\n  // Разрешим фронту показывать кнопки\n  try {\n    if (app.forum?.data?.attributes) {\n      app.forum.data.attributes.canStartDiscussion = true;\n    }\n  } catch (_) {}\n\n  // Подстраховка на темы, скрывающие кнопки\n  const style = document.createElement('style');\n  style.textContent = `\n    .Button--newDiscussion,\n    .item-reply .Button { display:inline-flex !important; opacity:1 !important; pointer-events:auto !important; }\n  `;\n  document.head.appendChild(style);\n\n  // Главная: добавляем кнопку \"New Discussion\"\n  extend(IndexPage.prototype, 'actionItems', function (items) {\n    items.add(\n      'anonGuestNewDiscussion',\n      Button.component(\n        {\n          className: 'Button Button--primary',\n          onclick: () => openNewDiscussionComposer({ withTags: true }),\n        },\n        app.translator.trans('core.forum.index.start_discussion_button')\n      ),\n      0\n    );\n  });\n\n  // Страница обсуждения: добавляем кнопку \"Reply\"\n  extend(DiscussionPage.prototype, 'actionItems', function (items) {\n    items.add(\n      'anonGuestReply',\n      Button.component(\n        {\n          className: 'Button Button--primary',\n          onclick: () => openReplyComposer(this.discussion),\n        },\n        app.translator.trans('core.forum.discussion.reply_button')\n      ),\n      0\n    );\n  });\n\n  // Перехват клика по уже существующим Reply (если их рендерит тема/расширения)\n  // document.addEventListener(\n  //   'click',\n  //   (e) => {\n  //     if (app.session?.user) return; // не мешаем залогиненным\n  //     const btn = e.target && e.target.closest('.item-reply .Button, [data-item-id=\"reply\"] .Button');\n  //     if (!btn) return;\n  //     e.preventDefault();\n  //     e.stopImmediatePropagation();\n  //     const current = app.current?.get?.('discussion');\n  //     if (current) openReplyComposer(current);\n  //   },\n  //   true\n  // );\n});\n"],"names":["flarum","core","compat","e","Error","code","module","exports","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","TagSelectionModal","require","app","add","_app$session","origSubmit","DiscussionComposer","onsubmit","data","this","relationships","tags","type","id","user","_app$forum","attributes","canStartDiscussion","_","style","document","createElement","textContent","head","appendChild","extend","IndexPage","items","Button","className","onclick","withTags","_ref$withTags","_temp","load","show","selectedTags","trans","DiscussionPage","_this","discussion","ReplyComposer"],"sourceRoot":""}